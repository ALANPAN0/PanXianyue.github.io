<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Creating Custom Instruments · dreamerpanda</title><meta name="description" content="Creating Custom Instruments - panda"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="dreamerpanda"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/sunchongsheng" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/pinggod" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Creating Custom Instruments</h1><div class="post-info">Jun 26, 2018</div><div class="post-content"><p>session 410</p>
<a id="more"></a>
<blockquote>
<p>Instruments 是一款强大且灵活的性能分析工具，集成在 Xcode 的开发者工具集中<br>我们能够用不同的 Instrument 来分析测试各种各样的性能问题<br>比如 Leaks 来查内存泄漏问题，Time Profiler 来分析 App 的页面卡顿问题等等</p>
</blockquote>
<h3 id="u4E3A_u4EC0_u4E48_u8981_u521B_u5EFA_u81EA_u5B9A_u4E49_u7684_u5DE5_u5177__3F"><a href="#u4E3A_u4EC0_u4E48_u8981_u521B_u5EFA_u81EA_u5B9A_u4E49_u7684_u5DE5_u5177__3F" class="headerlink" title="为什么要创建自定义的工具 ?"></a>为什么要创建自定义的工具 ?</h3><p>系统已经自带了大量的工具, 这些工具苹果已经通过文档模板 创建好并集成在 Instruments 的启动选择界面里<br>比如上文中提到的 Leaks 和 Time Profiler 相信很多人都有使用过</p>
<p>Instruments 10 的启动界面:<br><img src="/images/15299175880026.jpg" alt=""></p>
<p>但是这些内置工具的使用其实很大程度上是基于我们对自己代码的充分了解，那么如何让不懂这部分代码的人也能够很快了解 App 的运行数据呢<br>比如测试 App 的网络层性能数据？<br>这时候，一个良好的 Instruments 自定义工具或许就是那个答案，它能够出色地描述 App 运行情况。<br>另外，如果想为内置的 Instruments 工具换个界面，或者系统提供的工具不够用了，这些问题也能够通过创建自定义 Instruments 工具来得到解决。</p>
<h3 id="Instruments_10__u7684_u67B6_u6784_u4F53_u7CFB"><a href="#Instruments_10__u7684_u67B6_u6784_u4F53_u7CFB" class="headerlink" title="Instruments 10 的架构体系"></a>Instruments 10 的架构体系</h3><p>介绍 Instrument 10 的架构之前，我们先回顾下以往苹果是怎么维护 Instruments 组件的</p>
<p><img src="/images/15299178011209.jpg" alt=""></p>
<p>最早一个版本的 Instruments 拖拽不同的 Library 到 Instruments 点击 Record 的后便可以执行一系列的性能工具，但这些基础库并没有提供良好的方式来继续更新维护。<br>早期苹果通过继承现有的工具完成迭代，但每个工具都有自己的数据记录和分析模式，他们不得不设计一个自定义的存储机制来获取追踪到的数据，然后再设计一个自定义的界面来整合其他新增的应用。<br>这种方式随着不断地迭代，维护成本越来越高，每添加一个新的功能，就必须要修改之前最原始的那几个工具库，这样在旧的架构上完成自定义 Instrument 的将会变得极其痛苦，最终苹果放弃了旧的架构，从而也才有了现在的 Instruments 10。</p>
<p><img src="/images/15299179601287.jpg" alt=""></p>
<p>全新的 Instruments 架构分为 『标准界面（Standard UI）』 和 『分析核心（Analysis Core）』 两个标准组件，二者分工不同但却紧密连接<br>『标准界面』组件负责用户交互，而『分析核心』负责数据存储和统计分析。现在 Instruments 10 中的工具库已经都是基于这个所创建，我们甚至完全可以自己基于这两个标准组件做一个与苹果内置工具一模一样的东西</p>
<h3 id="u754C_u9762_u4ECB_u7ECD"><a href="#u754C_u9762_u4ECB_u7ECD" class="headerlink" title="界面介绍"></a>界面介绍</h3><p><img src="/images/15299183312590.jpg" alt=""></p>
<p>从上图可以看出，Instruments 10 的界面变化并不大，与以往的版本结构差不多。<br>但正如前面提到的，架构变化使得现在的界面数据都将由『分析核心』提供，我们有必要来了解下其数据结构是怎么设计的。<br>下图就是一张数据表的格式。</p>
<p><img src="/images/15299184203962.jpg" alt=""></p>
<p>『分析核心』以表的形式将数据传递给『标准界面』，而这些表可以通过一个简单的 Table Schema 定义。Table Schema 就和我们 OC 或者 Swift 中的类一样，描述了这个 Table 是什么。<br>也正是出于这种设计，我们接下来才能够使用 Table Schema 来完成自定义 Instrument 的创建。</p>
<h3 id="Instruments__u81EA_u5B9A_u4E49_u5DE5_u5177_u7684_u521D_u7EA7_u3001_u4E2D_u7EA7_u4EE5_u53CA_u9AD8_u7EA7_u5E94_u7528"><a href="#Instruments__u81EA_u5B9A_u4E49_u5DE5_u5177_u7684_u521D_u7EA7_u3001_u4E2D_u7EA7_u4EE5_u53CA_u9AD8_u7EA7_u5E94_u7528" class="headerlink" title="Instruments 自定义工具的初级、中级以及高级应用"></a>Instruments 自定义工具的初级、中级以及高级应用</h3><h6 id="u521D_u7EA7_u5E94_u7528"><a href="#u521D_u7EA7_u5E94_u7528" class="headerlink" title="初级应用"></a>初级应用</h6><p>有了足够的理论知识后，我们可以尝试下简单的自定义工具创建了。</p>
<p><img src="/images/15299185368021.jpg" alt=""></p>
<p>Instruments 10 创建自定义工具和创建工程的步骤几乎一样，只是最后 Project 模板需要切换到 macOS 栏下，选择 Instruments Package，并填写好工程名等信息即可。</p>
<p><img src="/images/15299185915929.jpg" alt=""></p>
<p>工程创建完成后，在左侧导航中已经自动生成了一个后缀为 .instrpkg 的 XML 文件，所有的配置都会在这个 XML 文件中完成，其中默认已经帮我生成了包含一些基础信息。接着我们要做的就是按照我们的需要去写这个配置文档了。</p>
<ul>
<li>导入需要使用的 Schema</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#60;!-- MARK: &#23548;&#20837;&#20320;&#38656;&#35201;&#20351;&#29992;&#30340; schema --&#62;&#10;&#60;import-schema&#62;tick&#60;/import-schema&#62;</span><br></pre></td></tr></table></figure>
<ul>
<li>完成 Instrument 的『标准界面』和『分析核心』配置</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#60;!-- MARK: &#23548;&#20837;&#20320;&#38656;&#35201;&#20351;&#29992;&#30340; schema --&#62;&#10;    &#60;import-schema&#62;tick&#60;/import-schema&#62;&#10;    &#60;instrument&#62;&#10;        &#60;!-- MARK: &#36825;&#20010; Instrument &#30340;&#22522;&#26412;&#20449;&#24687; --&#62;&#10;        &#60;id&#62;com.Parsifal.TicksDemo&#60;/id&#62;&#10;        &#60;title&#62;Ticks&#60;/title&#62;&#10;        &#60;category&#62;Behavior&#60;/category&#62;&#10;        &#60;purpose&#62;Instrument drawing ticks every 100ms&#60;/purpose&#62;&#10;        &#60;icon&#62;Generic&#60;/icon&#62;&#10;        &#10;        &#60;!-- MARK: &#25551;&#36848;&#30340;&#34920;&#25968;&#25454;&#65292;&#23558;&#20250;&#30001; &#20998;&#26512;&#26680;&#24515; &#26368;&#32456;&#23436;&#25104;&#23384;&#20648;&#21644;&#35299;&#26512;&#25552;&#20379;&#32473; &#26631;&#20934;&#30028;&#38754; &#27169;&#22359; --&#62;&#10;        &#60;create-table&#62;&#10;            &#60;id&#62;tick-table&#60;/id&#62;&#10;            &#60;!-- &#23450;&#20041;&#20102;&#27599;&#21015;&#30340;&#25968;&#25454; --&#62;&#10;            &#60;schema-ref&#62;tick&#60;/schema-ref&#62;&#10;        &#60;/create-table&#62;&#10;        &#10;        &#60;!-- MARK: &#22270;&#24418;&#35270;&#22270;&#19978;&#38754;&#23637;&#31034;&#65288;&#21487;&#36873;&#65289; --&#62;&#10;        &#60;graph&#62;&#10;            &#60;title&#62;Ticks&#60;/title&#62;&#10;            &#60;lane&#62;&#10;                &#60;title&#62;Lane&#60;/title&#62;&#10;                &#60;!-- &#36825;&#37324;&#23601;&#26159;&#19978;&#38754;&#20320;&#23450;&#20041;&#30340; table id--&#62;&#10;                &#60;table-ref&#62;tick-table&#60;/table-ref&#62;&#10;                &#60;plot&#62;&#10;                    &#60;value-from&#62;time&#60;/value-from&#62;&#10;                &#60;/plot&#62;&#10;            &#60;/lane&#62;&#10;        &#60;/graph&#62;&#10;        &#10;        &#60;!-- MARK: &#36825;&#37324;&#25551;&#36848;&#20320;&#38656;&#35201;&#23637;&#31034;&#22312;&#35814;&#24773;&#35270;&#22270;&#30340;&#25968;&#25454; --&#62;&#10;        &#60;list&#62;&#10;            &#60;title&#62;Ticks&#60;/title&#62;&#10;            &#60;!-- &#36825;&#37324;&#23601;&#26159;&#19978;&#38754;&#20320;&#23450;&#20041;&#30340; table id--&#62;&#10;            &#60;table-ref&#62;tick-table&#60;/table-ref&#62;&#10;            &#60;column&#62;time&#60;/column&#62;&#10;        &#60;/list&#62;&#10;    &#60;/instrument&#62;</span><br></pre></td></tr></table></figure>
<p>至此我们便已经完成了所有的编码工作了<br>编译运行后，在弹出的 Instruments 选择窗口里选择 Blank 就可以在测试界面的 Library 中发现我们自己定义的工具了，直接拖入 Instruments 里就能够像使用其他内置工具一样运行</p>
<p><img src="/images/15299191086255.jpg" alt=""></p>
<h3 id="u603B_u7ED3"><a href="#u603B_u7ED3" class="headerlink" title="总结"></a>总结</h3><p>Instruments 10 提供了太多创建自定义 Instrument 的可能性了，不过这同样需要我们花点时间来学习掌握新一套的编写方式。对于大多数客户端开发者来说，或许并不会用到上面谈的这部分技能，但对于测试团队来说，这无疑为 iOS App 的性能测试又打开了一扇窗。相信在未来的一年里，圈子内会陆陆续续地有高质量自定义 Instrument 的产出，让我们一起期待。</p>
<h3 id="More_Information"><a href="#More_Information" class="headerlink" title="More Information"></a>More Information</h3><p><a href="https://developer.apple.com/wwdc18/410" target="_blank" rel="external">https://developer.apple.com/wwdc18/410</a></p>
</div></article></div></main><footer><div class="paginator"><a href="/2018/06/26/415-behind-the-scenes-of-the-xcode-build-process/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2018 <a href="http://yoursite.com">panda</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>